<?php
/*
 * @author 		Marc Sven Kleinboehl
 * @created 	01/14/2012
 * @copyright	2012 Â© Bright Solutions GmbH
 * 
 * ERPAL mail to action handling for CRM.
 */
 

// The group string of the configuration.
define ('ERPAL_CRM_MAILACTION_CONFIG_GROUP_MAILBOX', 'mailbox');
define ('ERPAL_CRM_MAILACTION_CONFIG_GROUP_MAILBOX_SETTINGS', 'mailbox_settings');
define ('ERPAL_CRM_MAILACTION_CONFIG_GROUP_IMPORT_SETTINGS', 'import');

// The UID of the site admin.
define ('ERPAL_CRM_MAILACTION_ADMIN_UID', 1);


/**
* Implements hook_menu.
*/ 
function erpal_crm_mailaction_menu(){

  $items = array();
  
  require_once 'inc/config.inc';
  $config_items = _erpal_crm_mailaction_config_menu();

  return array_merge($items, $config_items);
} 

/**
* Implements hook_permission.
*/
function erpal_crm_mailaction_permission(){
  
  return array(
    'config erpal crm mailaction' => array(
      'title'       => t('Administer ERPAL mail action handler'), 
      'description' => t('Perform administration tasks for ERPAL crm mail action module.'),
    ),
    'reply mails erpal crm mailaction' => array(
      'title'       => t('Mail reply from node'), 
      'description' => t('Shows a mailto reply link for the specific user..'),
    ),
  );
} 

/*
 * Implements hook_cron.
 */
function erpal_crm_mailaction_cron () {
  
  if (! lock_acquire('erpal_crm_mailaction')) {
    watchdog ('erpal_crm_mailaction', t('Can not run mail action cron. Because, of a concurrent cron process.'));
    return;
  }
  
  module_load_include ('inc', 'erpal_crm_mailaction', 'inc/CronProcessor/CronProcessor.class');
  erpal_crm_mailaction\CronProcessor::run ();
  
  lock_release('erpal_crm_mailaction');
  
  return;
}

/*
 * A simple page wrapper for the cron function.
 */
function _erpal_crm_mailaction_cron_page_wrapper () {
  
  if (! user_access ('config erpal crm mailaction')) {
    drupal_access_denied();
    return;
  }
  
  erpal_crm_mailaction_cron ();
  
  drupal_set_message (t('Mails were imported.'));
  
  drupal_goto ('admin/erpal/crm-mailaction');
  
  return ' ';
}

/*
 * Implements hook_erpal_crm_mailaction_incoming. 
 */
function erpal_crm_mailaction_erpal_crm_mailaction_incoming ($to, $from, $subject, $body, $attachments) {

  module_load_include ('inc', 'erpal_crm_mailaction', 'inc/Import/Import.class');  
  erpal_crm_mailaction\Import::import ($to, $from, $subject, $body, $attachments);
  
  return;
}

/*
 * Implements hook_theme.
 */
function erpal_crm_mailaction_theme () {
  
  return array (
    'erpal_crm_mailaction_comment' => array (
      'template'  => 'templates/erpal_crm_mailaction_comment',
      'variables'	=> array ('from'=>'', 'to'=>'', 'body'=>'')
    )
  );
}

/*
 * A settings getter.
 * @param 	string	The name of the settings group.
 * @param		string	The key of the settings value.
 * @return	mixed 	The settings value on success. Otherwise NULL.
 */
function _erpal_crm_mailaction_get_settings ($group, $key, $default_value = NULL) {
  
  $settings = variable_get ('erpal_crm_mailaction', array ());

  return isset ($settings[$group][$key]) ?
  $settings[$group][$key] :
  $default_value;
}

