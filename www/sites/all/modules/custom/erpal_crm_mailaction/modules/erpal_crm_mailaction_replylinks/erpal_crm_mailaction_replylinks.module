<?php
/*
 * @author 		Marc Sven Kleinboehl
 * @created 	01/14/2012
 * @copyright	2012 Â© Bright Solutions GmbH 
 * 
 * An extension for adding reply links to the CRM actions.
 */


 
 
/**
* Implements hook_theme_registry_alter
*/
function erpal_crm_mailaction_replylinks_preprocess_node(&$vars) {

  if ($vars['type'] != 'erpal_crm_activity') {
    return;
  }

  $vars['content']['links']['#links'] = _erpal_crm_helper_create_node_reply_links ($vars);
   
  return;
}

/**
* Implements hook_theme_registry_alter
*/
function erpal_crm_mailaction_replylinks_preprocess_comment (&$vars) {
 
  if ($vars['type'] != 'erpal_crm_activity') {
  //  return;
  }
// TODO
  
 // $vars['content']['links']['#links'] = _erpal_crm_helper_create_node_reply_links ($vars);
   
  return;
}

/*
 * This function creates the config array for a reply link.
 * @param 	string $receiver	The email of the receiver.
 * @param 	string $subject		The subject of the mail.
 * @param 	string $ticket		The ticket number.
 * @return	array							A config array for a theme link function.
 */
function _erpal_crm_helper_create_reply_link ($receiver, $subject, $ticket) {
  
  if (drupal_load ('module', 'erpal_crm_mailaction')) {
    $cc = _erpal_crm_mailaction_get_settings (ERPAL_CRM_MAILACTION_CONFIG_GROUP_IMPORT_SETTINGS, 'cc_box');
  }
  
  return array ( 
    'title'=> t('Reply to @receiver', array ('@receiver'=>$receiver)),
    'href' => 'mailto: ' . 
      $receiver . 
      '?subject=Re:' . 
      $subject . 
      ' [ticket:' . $ticket . ']' .
      (isset ($cc) ? '&cc=' . $cc : ''),
    'html' => TRUE,
    'attributes' => array ('class'=>array('erpal_crm_mail_action_replylink'))
  );
}

/*
 * This function creates a list of conversation partners.
 * @param  object $activity_node	The node object of the activity node.
 * @return array 									The reply links of the activity.
 */
function _erpal_crm_helper_create_node_reply_links ($activity_node) {

  $node  = node_load ($activity_node['nid']);
  $links = array ();
  
  foreach ($activity_node['field_contacts_ref'] as $index=>$contact) {
    
    $entity = $contact['entity'];
    
    $links['reply_' . $index] = _erpal_crm_helper_create_reply_link (
      isset ($entity->field_email[LANGUAGE_NONE]) ? $entity->field_email[LANGUAGE_NONE][0] ['value'] : '',
      $node->title, 
      $activity_node['nid']
    );
  }
 
  return $links;
}
