<?php
/**
 * @file
 * Module to provide helper functions for book feature
 */

 /**
 * Implements hook_node_presave
 */
function erpal_book_helper_node_presave($node) {
  _erpal_book_helper_connect_page_to_book($node);
}

/**
* Ensures that the book page references the top most parent book it belongs to!
*/
function _erpal_book_helper_connect_page_to_book($node) {
  $parent_nid = 0;
  if (isset($node->field_parent[LANGUAGE_NONE][0]['nid']))
    $parent_nid = $node->field_parent[LANGUAGE_NONE][0]['nid'];
  
  if (!$parent_nid)
    return;
  
  $parent_node = node_load($parent_nid);
  
  //get the book of the parent if there is a parent, otherwise the book
  //should be already prepoulated.
  $book_nid = 0;
  if ($parent_node->type == 'erpal_book') {
    $book_nid = $parent_node->nid;
  }
  elseif (isset($parent_node->field_book_ref[LANGUAGE_NONE][0]['nid'])) {
    $book_nid = $parent_node->field_book_ref[LANGUAGE_NONE][0]['nid'];
  }
    
  if ($book_nid)
    $node->field_book_ref[LANGUAGE_NONE][0]['nid'] = $book_nid;
}

/**
* Implements hook_form_alter
*/
function erpal_book_helper_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_book_page_node_form') {
    _erpal_book_helper_form_redirect_orphan_book_page($form);
  }
}

/**
* Redirects from a form to books view if the user doesnt add a book-page over a book but using node/add/book_page
*/
function _erpal_book_helper_form_redirect_orphan_book_page($form) {
  //check book page must have a book reference or a parent refernce, otherwise redirect
  //to destination or if not set to books view
  //$book_nid = $form['field_book_ref'][LANGUAGE_NONE][0]['nid']['#default_value'];
  $parent_nid = $form['field_parent'][LANGUAGE_NONE][0]['nid']['#default_value'];
  
  if (!$parent_nid) {
    //redirect
    $destination = drupal_get_destination();
    $destination = $destination['destination'];
    
    if (!$destination || $destination == $_GET['q'])
      $destination = 'books/books';

    drupal_goto($destination);
  }
}

/**
* This function is called by the view books. Links for creating some nodes are added. 
* With the hook other modules could add some more links.
*/
function _erpal_book_helper_view_contacts_header_content() {
  
  $add_erpal_book = _erpal_book_helper_create_book_link();
  
  $my_content = array(
    $add_erpal_book,
  );
  
  //ask all other modules for content in the header area of the view
  $other_module_content = module_invoke_all('view_books_header_content');
  
  $all_content = array_merge($other_module_content, $my_content);
  
  $content = '';
  foreach ($all_content as $a_content) {
    $content .= '<br>'.$a_content;
  }
  
  return $content;
}

/**
* Helper function to create new book link
*/
function _erpal_book_helper_create_book_link($q_arg = false, $query_arr = array(), $title=false){
  if (!$q_arg)
    $q = current_path();
  else 
    $q = $q_arg;
  
  if (!isset($query_arr['destination']) || $q_arg)
    $query_arr['destination'] = $q;
  
  if (!$title)
    $title = t("Create new book");
    
  return l(
    $title, "node/add/erpal-book", array(
        'query' => $query_arr,
    )
  );
}