<?php
/**
 * @file
 * Module to provide helper functions for book feature
 */
 
 /**
 * Implements hook_node_presave
 */
function erpal_book_helper_node_presave($node) {
  _erpal_book_helper_connect_page_to_book($node);
}

/**
* Implements hook_menu
*/ 
function erpal_book_helper_menu(){

  $items = array();
  
  $items['books/%node/pdf'] = array(
    'title' => 'Create PDF of book',
    'page callback' => '_erpal_books_helper_book_pdf_menu_callback',    
    'page arguments' => array(1),
    'access callback' => '_erpal_book_helper_book_pdf_menu_access',
    'access arguments' => array(1),
    'file' => 'inc/book.pdf.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
} 

/**
* Implements hook_theme
*/
function erpal_book_helper_theme() {
  return array(
    'erpal_books_book_pdf_html' => array(
      'variables' => array('node' => NULL, 'pdf_object' => NULL),
      'template' => 'template/book_pdf_html',
    ),
    'erpal_books_children_html' => array(
      'variables' => array('html' => '', 'parent_node' => false),
      'template' => 'template/children_html',
    ),
  );
}

/**
* Access Callback for url to create a pdf from a book
*/
function _erpal_book_helper_book_pdf_menu_access($node) {
  if ($node->type == 'erpal_book')
    if (!user_access('create erpal_book content'))
      return false;
      
  if ($node->type == 'erpal_book_page')
    if (!user_access('create erpal_book_page content'))
      return false;
   
  //validate that given node is of type book or book_page
  $type_ok = $node->type == 'erpal_book' || $node->type == 'erpal_book_page';
  
  return $type_ok;
   
  return true;
}

/**
* Implements hook_node_view
*/
function erpal_book_helper_node_view($node) {
  
  if ($node->type == 'erpal_book' || $node->type == 'erpal_book_page') {
    
    $links[] = array(
      'href' => 'books/'.$node->nid.'/pdf',
      'title' => t('Create PDF'),
      'attributes' => array('class' => 'book_pdf_link'),
    );
    
    $node->content['links']['erpal_book_pdf'] = array(
      '#links' => $links,
      '#attributes' => array('class' => array('links', 'inline')),
    );
  }
  
}

function erpal_book_helper_field_attach_view_alter (&$output, $context) {
  
  if ($context['entity_type'] == 'node') {
    if ($context['entity']->type == 'erpal_book' || $context['entity']->type == 'erpal_book_page') {
      if (isset($output['body'])) {                
        
        //get the contact and the address enttiy 
        $data = array();
        $book_node = $context['entity'];
        
        if ($book_node->type == 'erpal_book_page') {
          //get the parent book at top most level because contact information are stored there
          $book_nid = $book_node->field_book_ref[LANGUAGE_NONE][0]['nid'];
          $book_node = node_load($book_nid);
        }
        
        //get the contact and the selected address of the contact
        if (!isset($book_node->field_contact_ref[LANGUAGE_NONE][0]['nid']))
          return;
          
        $contact_nid = $book_node->field_contact_ref[LANGUAGE_NONE][0]['nid'];
        $contact_node = node_load($contact_nid);
        
        $address_id = false;
        $address_entity = false;
        if (isset($book_node->field_address_id[LANGUAGE_NONE][0]['value'])) {
          $address_id = $book_node->field_address_id[LANGUAGE_NONE][0]['value'];
          $address_entity = entity_load('field_collection_item', array($address_id));
          $address_entity = $address_entity[$address_id];
        }
        
        $data['contact_node'] = $contact_node;
        $data['address_entity'] = $address_entity;
        $output['body'][0]['#markup'] = token_replace($output['body'][0]['#markup'], $data);        
      }
    }
  }
}

/**
* implements hook_init
*/
function erpal_book_helper_init() {
  //@TODO that is really bad, but we have no other chance right now. The problem is:
  //if the customer changes in an book, we change the allowed values using #ajax at the contact
  //form element. This ajax function sumbits the whole form. While rebuilding the form again, the function
  //to get the allowed values of the field is called bevore hook_form_alter. But we need the value of the selected contact
  //to decide which are the allowed values. So we need a oportunity to get the value of the contact field BEVORE 
  //the function for allowed values is called. This is what we do here.
  //@see same dirty thing in erpal_invoice_helper.module with customer selection of an invoice.
  
  if (isset($_POST['field_contact_ref']))
    if (isset($_POST['field_contact_ref'][LANGUAGE_NONE]))
      if (isset($_POST['field_contact_ref'][LANGUAGE_NONE][0]))
        if (isset($_POST['field_contact_ref'][LANGUAGE_NONE][0]['nid'])) {
          $contact_nid = $_POST['field_contact_ref'][LANGUAGE_NONE][0]['nid'];
          $contact_nid = _erpal_basic_helper_get_nid_from_autocomplete_string($contact_nid);
          _erpal_book_helper_cache('erpal_ajax_adresses', $contact_nid);
        }
}
 
/**
* Value callback for address id field if book node
*/
function erpal_book_helper_field_address_id_allowed_values($field) {
  if ($field['field_name'] != 'field_address_id') {    
    return array();
  } else {
    //@TODO getting the current node from url args is kind of dirty, but I actually
    //dont know how to do it better and we need the current node to get information
    //if it is edit and we have already a customer set to get its available addresses        
    $book_nid = arg(1);
  }

  $cached_contact_nid = _erpal_book_helper_cache('erpal_ajax_adresses', false);  //get cached customer and clear cache
  if ($cached_contact_nid) {
    $contact_node = node_load($cached_contact_nid);
  }
  elseif ($book_nid && intval($book_nid)."" == $book_nid.""){ //ensure it is an integer and not "add"
    $book_node = node_load($book_nid);  
    
    if (!isset($book_node->field_contact_ref[LANGUAGE_NONE][0]['nid']))
      return array();
      
    $contact_nid = $book_node->field_contact_ref[LANGUAGE_NONE][0]['nid'];
    $contact_node = node_load($contact_nid);    
  } else
    return array();

  $allowed_values = _erpal_basic_helper_get_contact_adresses($contact_node, true);

  return $allowed_values;
}

/**
* Ensures that the book page references the top most parent book it belongs to!
*/
function _erpal_book_helper_connect_page_to_book($node) {
  $parent_nid = 0;
  if (isset($node->field_parent[LANGUAGE_NONE][0]['nid']))
    $parent_nid = $node->field_parent[LANGUAGE_NONE][0]['nid'];
  
  if (!$parent_nid)
    return;
  
  $parent_node = node_load($parent_nid);
  
  //get the book of the parent if there is a parent, otherwise the book
  //should be already prepoulated.
  $book_nid = 0;
  if ($parent_node->type == 'erpal_book') {
    $book_nid = $parent_node->nid;
  }
  elseif (isset($parent_node->field_book_ref[LANGUAGE_NONE][0]['nid'])) {
    $book_nid = $parent_node->field_book_ref[LANGUAGE_NONE][0]['nid'];
  }
    
  if ($book_nid)
    $node->field_book_ref[LANGUAGE_NONE][0]['nid'] = $book_nid;
}

/**
* Implements hook_form_alter
*/
function erpal_book_helper_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_book_page_node_form') {
    _erpal_book_helper_form_redirect_orphan_book_page($form);
    _erpal_book_helper_show_patterns_at_body($form, $form_state);
    _erpal_book_helper_alter_form_fields($form, $form_state);
  }
  
  if ($form_id == 'erpal_book_node_form') {
    _erpal_book_helper_show_patterns_at_body($form, $form_state);
    _erpal_book_helper_prepare_address_ajax_reload($form, $form_state);
  }
}

/**
* Alter e.g. hide some form fields
*/
function _erpal_book_helper_alter_form_fields(&$form, $form_state) {
  $form['field_book_ref'][LANGUAGE_NONE]['#type'] = 'value';
  //value will be set in node_presave @see _erpal_book_helper_alter_form_fields
}

/**
* Prepare book node form to reload address field using AJAX, according to slected contact
*/
function _erpal_book_helper_prepare_address_ajax_reload(&$form, $form_state) {
  $form['field_address_id'][LANGUAGE_NONE]['#prefix'] = '<div id="address_wrapper">';
  $form['field_address_id'][LANGUAGE_NONE]['#suffix'] = '</div>';

  $form['field_contact_ref'] = _erpal_book_helper_field_customer_ref_alter($form['field_contact_ref']);
  
  //if address has only one option, make this option the default value
  $options = $form['field_address_id'][LANGUAGE_NONE]['#options'];
  $default_id = false;
  if (count($options) == 2) {
    //get the one that is not "_none" and delete it!    
    foreach ($options as $id=>$value) {
      if (!is_numeric($id))
        unset($form['field_address_id'][LANGUAGE_NONE]['#options'][$id]);
    }
  }
  if ($default_id) {
    $form['field_address_id'][LANGUAGE_NONE]['#default_value'] = $default_id;
  }
}

/**
* Alters the field contact ref to have an ajax callback to change the addresses after changing the contact of a book
*/
function _erpal_book_helper_field_customer_ref_alter($field) {

  $field[LANGUAGE_NONE][0]['nid']['#ajax'] = array(
    'callback' => '_erpal_book_helper_ajax_book_preselect_addresses',
    'wrapper' => 'address_wrapper',
    'method' => 'replace',
    'effect' => 'fade',
  );
  
  return $field;
}

/**
* Callback after contact_ref field on book form has changed with ajax callback
*/
function _erpal_book_helper_ajax_book_preselect_addresses($form, $form_state) {  
    
  return $form['field_address_id'][LANGUAGE_NONE];  //form has already been processed, so just return the elements
}


/**
* Show patterns for contact and address at book page or book nodes
*/
function _erpal_book_helper_show_patterns_at_body(&$form, $form_state) {
  $tokens = theme('token_tree', array('global_types' => FALSE, 'token_types' => array('erpal_contact')));
  $form['body'][LANGUAGE_NONE]['#suffix'] .= $tokens;
}

  
/**
* Redirects from a form to books view if the user doesnt add a book-page over a book but using node/add/book_page
*/
function _erpal_book_helper_form_redirect_orphan_book_page($form) {
  //check book page must have a book reference or a parent refernce, otherwise redirect
  //to destination or if not set to books view
  $parent_nid = $form['field_parent'][LANGUAGE_NONE][0]['nid']['#default_value'];
  
  if (!$parent_nid) {
    //redirect
    $destination = drupal_get_destination();
    $destination = $destination['destination'];
    
    if (!$destination || $destination == $_GET['q'])
      $destination = 'books/books';

    drupal_goto($destination);
  }
}

/**
* This function is called by the view books. Links for creating some nodes are added. 
* With the hook other modules could add some more links.
*/
function _erpal_book_helper_view_contacts_header_content() {
  
  $add_erpal_book = _erpal_book_helper_create_book_link();
  
  $my_content = array(
    $add_erpal_book,
  );
  
  //ask all other modules for content in the header area of the view
  $other_module_content = module_invoke_all('view_books_header_content');
  
  $all_content = array_merge($other_module_content, $my_content);
  
  $content = '';
  foreach ($all_content as $a_content) {
    $content .= '<br>'.$a_content;
  }
  
  return $content;
}

/**
* Checks if projects module is enabled and if it is, call a function that shows at which projects the given book is referenced
*/
function _erpal_book_helper_render_projects_referencing_books($book_nid) {
  if (module_exists('erpal_projects_helper'))
    return _erpal_projects_helper_render_projects_referencing_books($book_nid);
    
  return '';
}

/**
* Definie which node types are allowed as children of a parent in jstree
* structure is 'parent_type' => array with possible child types
* @see views_jstree.module function theme_views_jstree
*/
function erpal_book_helper_jstree_allowed_child_types() {
  return array(
    'erpal_book' => array('erpal_task'),
    'erpal_book_page' => array('erpal_book_page', 'erpal_task'),
  );
}

/**
* Implements hook_jstree_context_menu to provide custom menu for book js tree, dependent on the node type
*/
function erpal_book_helper_jstree_context_menu($entity_type, $type, $id, $root_id) {
  
  $current_viewed_url = $_SESSION['view_jstree']['current_tree_url']; //@TODO dirty but works, if we delete a node in the tree we want to be redirected to the curent tree view againt und this is where we are actually.
  $query_back = array('destination' => $current_viewed_url);
  
  if ($type == 'erpal_book_page') {        

    $menu = array(
      array('title' => t('View'), 'url' => url('node/'.$id)),
      array('title' => t('Edit'), 'url' => url('node/'.$id.'/edit', array('query' => $query_back))),
      array('title' => t('Delete'), 'url' => url('node/'.$id.'/delete', array('query' => $query_back))),
      array('title' => t('Add sub page'), 'url' => url('node/add/erpal-book-page/'.$id, array('query' => $query_back))),
    );
     
    return $menu;
  }
}

/**
* Helper function to create new book link
*/
function _erpal_book_helper_create_book_link($q_arg = false, $query_arr = array(), $title=false){
  if (!$q_arg)
    $q = current_path();
  else 
    $q = $q_arg;
  
  if (!isset($query_arr['destination']) || $q_arg)
    $query_arr['destination'] = $q;
  
  if (!$title)
    $title = t("Create new book");
    
  return l(
    $title, "node/add/erpal-book", array(
        'query' => $query_arr,
    )
  );
}

/**
* Returns all direct children of a given book node
* we are keeping the correct order sorting by weight
*/
function _erpal_book_helper_get_children($book_node, $parent_node, $options) {
  
  //first get all book pages
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
  ->entityCondition('bundle', 'erpal_book_page')
  ->propertyCondition('status', 1)
  ->fieldCondition('field_parent', 'nid', $parent_node->nid, '=')
  ->fieldCondition('field_book_ref', 'nid', $book_node->nid, '=')
  ->fieldOrderBy('field_weight', 'value', 'ASC');

  if (!$options['ignore_exclude']['pdf']) {
    //exclude some node from export
    $exclude = array('pdf');
    
    //normally we would do it lik
    //$query->fieldCondition('field_page_exclude_from', 'value', 'pdf', '!=');
    //but that doenst work if field has no value, not even NULL at all. So we get all excluded nids and
    //exclude them in the query.
    $field['field'] = 'field_page_exclude_from';
    $field['column'] = 'value';
    $excluded = _erpal_book_helper_get_excluded_nodes_by_parent($parent_node, 'pdf', $field);
    
    if (count($excluded) > 0)
      $query->propertyCondition('nid', $excluded, 'NOT IN');
  }
  
  $result = $query->execute();
  $child_book_page_nodes = array();
  if (isset($result['node'])) {
    $child_nids = array_keys($result['node']);
    $child_book_page_nodes = entity_load('node', $child_nids);
  }
  
  //ask other modules for children  

  $other_child_nodes = module_invoke_all('book_child_nodes', $parent_node, $book_node, $options);
  
  $children = array_merge($child_book_page_nodes, $other_child_nodes);
  
  return $children;
}

/**
* Returns all excluded nids of type erpal_book linked to a given book
*/ 
function _erpal_book_helper_get_excluded_nodes_by_parent($parent_node, $exclude, $excluded_field) {
 
  if (!$exclude)
    return array();
    
  if ($exclude && !is_array($exclude))
    $exclude = array($exclude);

  //first get all book pages
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
  ->propertyCondition('status', 1)
  ->fieldCondition('field_parent', 'nid', $parent_node->nid, '=');

  $query->fieldCondition($excluded_field['field'], $excluded_field['column'], $exclude, 'IN');
  
  $result = $query->execute();
  $excluded_nids = array();
  if (isset($result['node'])) {
    $excluded_nids = array_keys($result['node']);
  }
  
  return $excluded_nids;
}

/**
* Runtime cache for saving values during script processing
*/
function _erpal_book_helper_cache($key, $value=false) {
  static $cache = array();

  $ret = false;
  if (isset($cache[$key]))
    $ret = $cache[$key];
    
  if ($value)
    $cache[$key] = $value;
    
  return $ret;
}