<?php
/**
 * @file
 * Module to provide helper functions for book feature
 */

 /**
 * Implements hook_node_presave
 */
function erpal_book_helper_node_presave($node) {
  _erpal_book_helper_connect_page_to_book($node);
}

/**
* Ensures that the book page references the top most parent book it belongs to!
*/
function _erpal_book_helper_connect_page_to_book($node) {
  $parent_nid = 0;
  if (isset($node->field_parent[LANGUAGE_NONE][0]['nid']))
    $parent_nid = $node->field_parent[LANGUAGE_NONE][0]['nid'];
  
  if (!$parent_nid)
    return;
  
  $parent_node = node_load($parent_nid);
  
  //get the book of the parent if there is a parent, otherwise the book
  //should be already prepoulated.
  $book_nid = 0;
  if (isset($parent_node->field_book_ref[LANGUAGE_NONE][0]['nid']))
    $book_nid = $parent_node->field_book_ref[LANGUAGE_NONE][0]['nid'];
    
  if ($book_nid)
    $node->field_book_ref[LANGUAGE_NONE][0]['nid'] = $book_nid;
}

/**
* Implements hook_form_alter
*/
function erpal_book_helper_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_book_page_node_form') {
    _erpal_book_helper_form_redirect_orphan_book_page($form);
  }
}

/**
* Redirects from a form to books view if the user doesnt add a book-page over a book but using node/add/book_page
*/
function _erpal_book_helper_form_redirect_orphan_book_page($form) {
  //check book page must have a book reference or a parent refernce, otherwise redirect
  //to destination or if not set to books view
  $book_nid = $form['field_book_ref'][LANGUAGE_NONE][0]['nid']['#default_value'];
  $parent_nid = $form['field_parent'][LANGUAGE_NONE][0]['nid']['#default_value'];
  
  if (!$book_nid && !$parent_nid) {
    //redirect
    $destination = drupal_get_destination();
    $destination = $destination['destination'];
    
    if (!$destination || $destination == $_GET['q'])
      $destination = 'books/books';

    drupal_goto($destination);
  }
}