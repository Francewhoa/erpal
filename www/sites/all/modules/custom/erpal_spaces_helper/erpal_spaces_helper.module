<?php
/**
 * @file
 * Code for the erpal_spaces_helper module.
*/

/**
* Implements hook_permission
*/
function erpal_spaces_helper_permission() {
  return array(
    'access spaces view' => array(
      'title' => t('Access spaces view'), 
      'description' => t('Allows the user to access the spaces view'),
    ),
    //TASKS
    'change group audience task' => array(
      'title' => t('Change group audience task'), 
      'description' => t('Allows the user to select the groups audience on task nodes'),
    ),
    'change group content visibility task' => array(
      'title' => t('Change group content visibility task'), 
      'description' => t('Allows the user to change the group-content visibility on task nodes'),
    ),
    
    //Projects
    'change group audience project' => array(
      'title' => t('Change group audience project'), 
      'description' => t('Allows the user to select the groups audience on project nodes'),
    ),
    'change group content visibility task' => array(
      'title' => t('Change group content visibility project'), 
      'description' => t('Allows the user to change the group-content visibility on project nodes'),
    ),
    
    //File
    'change group audience file' => array(
      'title' => t('Change group audience file'), 
      'description' => t('Allows the user to select the groups audience on file nodes'),
    ),
    'change group content visibility task' => array(
      'title' => t('Change group content visibility file'), 
      'description' => t('Allows the user to change the group-content visibility on file nodes'),
    ),
    
    //Timetracking
    'change group audience timetracking' => array(
      'title' => t('Change group audience timetracking'), 
      'description' => t('Allows the user to select the groups audience on timetracking nodes'),
    ),
    'change group content visibility timetracking' => array(
      'title' => t('Change group content visibility timetracking'), 
      'description' => t('Allows the user to change the group-content visibility on timetracking nodes'),
    ),
  );
}

/**
* Implements hook_form_alter
*/
function erpal_spaces_helper_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_task_node_form') {
    _erpal_spaces_helper_preset_parent_group_task($form, $form_state);
  }
}

/**
* For a tasks, if the form for inserting a new tasks is shown, we preselect the group to the group of the parent.
*/ 
function _erpal_spaces_helper_preset_parent_group_task(&$form, &$form_state) {

  $nid = $form['nid']['#value'];
  if ($nid) {  //only if node is new, preselect the group audience
    return;
  }
  
  $parent_node = _erpal_project_task_parent_from_form($form);
  
  //now prepopulate with the groups of the parent
  $group_audience = array();
  if (isset($parent_node->group_audience[LANGUAGE_NONE])) {
    foreach ($parent_node->group_audience[LANGUAGE_NONE] as $delta=>$group_arr) {
      $group_audience[$group_arr['gid']] = $group_arr['gid'];
    }
  }
  
  $form['group_audience'][LANGUAGE_NONE]['#default_value'] = $group_audience;
}

/**
* Implements hook_node_presave
*/
function erpal_spaces_helper_node_presave($node) {
  if ($node->type == 'erpal_task') {
    _erpal_spaces_helper_ensure_group_audience_task_presave($node);
  }
}

/**
* Make sure, that if a user that has not the permnission to change the group_audience field saves a node and the field is empty, the task will be placed in the group, where the tasks parent is placed
*/
function _erpal_spaces_helper_ensure_group_audience_task_presave($node) {
  global $user;
  
  $field = field_info_field('group_audience');
  if (!field_access('edit', $field, 'node', $node, $user) && !$node->nid) {
    //if user has no permission to access the field, and the node is new, we set the group to the group of the parent if one is set if there is a group set
    
    //first check if task has a parent task
    $parent_node = _erpal_project_task_parent($node);  //the parent may be a task or a project
    
    if ($parent_node) {
      //get the group(s) of the project
      $project_groups = $parent_node->group_audience[LANGUAGE_NONE];
      $node->group_audience[LANGUAGE_NONE] = $project_groups;
    }
  }
}


/**
* Implements hook field access
*/
function erpal_spaces_helper_field_access($op, $field, $entity_type, $entity, $account) {
  //Task
  if (is_object($entity) && $entity_type == 'node') {
    if ($entity->type == 'erpal_task') {
      if ($op == 'edit' && $field['field_name'] == 'group_audience') {
        return user_access('change group audience task');
      }
      
      if ($op == 'edit' && $field['field_name'] == 'group_content_access') {
        return user_access('change group content visibility task');
      }
    }
    
    //Project
    if ($entity->type == 'erpal_project') {
      if ($op == 'edit' && $field['field_name'] == 'group_audience') {
        return user_access('change group audience project');
      }
      
      if ($op == 'edit' && $field['field_name'] == 'group_content_access') {
        return user_access('change group content visibility project');
      }
    }
    
    //file
    if ($entity->type == 'erpal_file') {
      if ($op == 'edit' && $field['field_name'] == 'group_audience') {
        return user_access('change group audience file');
      }
      
      if ($op == 'edit' && $field['field_name'] == 'group_content_access') {
        return user_access('change group content visibility file');
      }
    }
    
    //timetracking
    if ($entity->type == 'erpal_timetracking') {
      if ($op == 'edit' && $field['field_name'] == 'group_audience') {
        return user_access('change group audience timetracking');
      }
      
      if ($op == 'edit' && $field['field_name'] == 'group_content_access') {
        return user_access('change group content visibility timetracking');
      }
    }
  }
}