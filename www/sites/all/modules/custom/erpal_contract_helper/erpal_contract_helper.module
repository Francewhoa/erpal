<?php
/**
 * @file
 * Code for the erpal_contract_helper module.
 */

/**
* Implements hook_permission
*/
function erpal_contract_helper_permission() {
  return array(
    'access contracts view' => array(
      'title' => t('Access contracts view'), 
      'description' => t('Allows the user to access the contracts view'),
    ),
  );
}

/**
* implements hook_form_alter
*/
function erpal_contract_helper_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_contract_node_form') {    
    _erpal_contract_helper_set_default_pricing($form, $form_state, $form_id);
    _erpal_contract_helper_manage_form_elements($form, $form_state, $form_id);
  }  
}

/**
* Manage form elements that we dont manage by display suite and renderable elements
*/
function _erpal_contract_helper_manage_form_elements(&$form, &$form_state, $form_id) {
  unset($form['field_budget_booking'][LANGUAGE_NONE][0]['field_budgets']);
}

/**
* Set default contractor, vat rate and currency if not set
*/
function _erpal_contract_helper_set_default_pricing(&$form, &$form_state, $form_id) {
  //set only for new node
  $nid = $form['nid']['#value'];
  if (!$nid) {
    $my_company_nid = _erpal_basic_helper_get_own_company_nid(false);
    $form['field_contract_payment'][LANGUAGE_NONE][0]['field_contractor_ref'][LANGUAGE_NONE][0]['target_id']['#default_value'] = _erpal_basic_helper_autocomplete_string_from_nid($my_company_nid);
    
    $default_currency = _erpal_invoice_helper_get_default_currency();
    $default_vat_rate = _erpal_invoice_helper_get_default_vat_rate();
    $form['field_contract_payment'][LANGUAGE_NONE][0]['field_vat_rate'][LANGUAGE_NONE]['#default_value'] = $default_vat_rate;
    $form['field_contract_payment'][LANGUAGE_NONE][0]['field_currency'][LANGUAGE_NONE]['#default_value'] = $default_currency;
  }
}

/**
* This function is called by the view contracts. Links for creating some nodes are added. 
* With the hook other modules add some more links.
*/
function _erpal_contract_helper_view_contracts_header_content() {
  
  $add_erpal_contract = _erpal_contract_helper_create_contract_link();
  
  $my_content = array(
    $add_erpal_contract,
  );
  
  //ask all other modules for content in the header area of the view
  $other_module_content = module_invoke_all('view_contracts_header_content');
  
  $all_content = array_merge($other_module_content, $my_content);
  
  $content = '';
  foreach ($all_content as $a_content) {
    $content .= '<br>'.$a_content;
  }
  
  return $content;
}


/**
* Helper function to create new contract link
*/
function _erpal_contract_helper_create_contract_link($q_arg = false, $query_arr = array(), $title=false){
  if (!$q_arg)
    $q = current_path();
  else 
    $q = $q_arg;
  
  if (!isset($query_arr['destination']) || $q_arg)
    $query_arr['destination'] = $q;
  
  if (!$title)
    $title = t("Create new contract");
    
  return l(
    $title, "node/add/erpal-contract", array(
        'query' => $query_arr,
    )
  );
}