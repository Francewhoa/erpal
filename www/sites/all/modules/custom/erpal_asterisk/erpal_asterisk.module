<?php
/*
 * @file
 * Code for the erpal_asterisk module.
 */



/*
* Implements hook_menu
*/ 
function erpal_asterisk_menu(){

  require_once 'inc/config.inc';
  $items = _erpal_asterisk_menu();
  return $items;
} 


/*
 * This function is callback for configuration of cor module
 */
function _erpal_asterisk_config(){
  
  return drupal_get_form('_erpal_asterisk_config_form');

}


/*
 * Forms wich list all views in erpal
 * @return array $form  Forms  
 */

function _erpal_asterisk_config_form() {
  
  $form= array();
  
  $form['description'] = array(
    '#type' => 'fieldset', 
    '#title' => t('Configurations of asterisk cor'),
    '#collapsible' => TRUE, // Added 
    '#collapsed' => FALSE, // Added
  );
    
  $form['description']['host'] = array(
    '#type'    	   => 'textfield', 
    '#title'       => t('HOST:'),
    '#default_value'		 => variable_get('asterisk_nodejs_host'),
    '#description' => t('Host of NodeJs Server'),
  );
  
  $form['description']['port'] = array(
    '#type' => 'textfield', 
    '#title' => t('PORT :'),
    '#default_value'		 => variable_get('asterisk_nodejs_port'),
    '#description' => t('Port of NodeJs Server'),
  );
  
  $form['description']['lifetime'] = array(
    '#type' => 'textfield', 
    '#title' => t('LIFETIME :'),
    '#default_value'		 => variable_get('asterisk_nodejs_lifetime'),
    '#description' => t('Lifetime of call'),
  );
  
  $form['submit'] = array(
    '#type' => 'submit', 
    '#value' => t('Save configurations'),
  );
 
  return $form;
  
}

/*
 *  Implemtent form Submit Function 
 */
function _erpal_asterisk_config_form_submit(&$form, &$form_state) {

  variable_set('asterisk_nodejs_host'  	 , $form_state['values']['host']);
  variable_set('asterisk_nodejs_port'    , $form_state['values']['port']);
  variable_set('asterisk_nodejs_lifetime', $form_state['values']['lifetime']);
   
}

/*
 *	Send data to the data dispatch server
 *
 *	@param data (string) The data to be sent
 *	@result A boolean indicating whether the communication was successful or not
 */
function erpal_asterisk_send_dispatch_data( $data, $source, $destination ) {
	//$file	= drupal_get_path('module','erpal_asterisk').'/last_call.htm';
	//file_put_contents( $file, $data );
  
  //set POST variables
  $url = variable_get('asterisk_nodejs_host') . ':' . variable_get('asterisk_nodejs_port') . '/ingoing';
  $fields = array(
      'receiverPhoneNumber' => urlencode($destination),
      'caller_data' => urlencode($data)
  );

  $fields_string = '';
  foreach($fields as $key=>$value) { $fields_string .= $key.'='.$value.'&'; }
  rtrim($fields_string,'&');

  //print "url: " . $url;
  //print "  fields: " . $fields_string;
  
  //open connection
  $ch = curl_init();

  //set the url, number of POST vars, POST data
  curl_setopt($ch,CURLOPT_URL,$url);
  curl_setopt($ch,CURLOPT_POST,count($fields));
  curl_setopt($ch,CURLOPT_POSTFIELDS,$fields_string);

  //execute post
  $result = curl_exec($ch);
  //print "result: " . $result;

  //close connection
  curl_close($ch);
}


/*
 * This function implements hook of asterisknotify module and get view of an contact
 */

function _erpal_asterisk_call($destination, $source = NULL){
  
  module_invoke_all('ingoing_call', $destination, $source);
  die();
  
  return implode (
  	'', 
    module_invoke_all('ingoing_call', $destination, $source)
  ); 
  //_erpal_asterisk_request();
}


function _erpal_asterisk_request($destination, $source = False, $html){

   // JAVASCRIPT REQUEST FOLGT HIER
   return $html; 
}


