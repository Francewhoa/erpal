<?php
/**
 * @file
 * Code for the erpal_projects_helper module.
 */

//@todo should be in hook_init?
module_load_include('inc', 'erpal_projects_helper', 'inc/projects');
module_load_include('inc', 'erpal_projects_helper', 'inc/tasks');
module_load_include('inc', 'erpal_projects_helper', 'inc/timetracking');
 
/**
* Implements hook_menu
*/ 
function erpal_projects_helper_menu(){

  $items = array();
  
  require_once 'inc/config.inc';
  $config_items = _erpal_projects_helper_config_menu();
  
  $items = array_merge($items, $config_items);
  return $items;
}
  
/**
* Implements hook_permission
*/
function erpal_projects_helper_permission(){
  return array(
    'config erpal projects' => array(
      'title' => t('Administer ERPAL Projects'), 
      'description' => t('Perform administration tasks for ERPAL Projects module.'),
    ),
  );
}

/**
* Implements hook_node_view
*/
function erpal_projects_helper_node_view($node) {
  if ($node->type == 'erpal_project') {
    $links[] = array(
      'href' => 'projects/timetrackings/'.$node->nid,
      'title' => t('Timetrackings'),
      'attributes' => array('class' => 'project_timetracking_links'),
    );
    $node->content['links']['erpal_projects_helper'] = array(
      '#links' => $links,
      '#attributes' => array('class' => array('links', 'inline')),
    );
  }
}

/**
* This function is called by the projects view to add a link for new project node
* it provides a hook to allow other modules to add a link to that view by implementing
* hook_
*/
function _erpal_projects_helper_view_projects_header_content()
{
  $q = current_path();
  $add_erpal_project =  _erpal_projects_helper_create_project_link();
  
  $my_content = array(
    $add_erpal_project,
  );
  
  //ask all other modules for content in the header area of the view
  $other_module_content = module_invoke_all('view_projects_header_content');
  
  $all_content = array_merge($other_module_content, $my_content);
  
  $content = '';
  foreach ($all_content as $a_content) {
    $content .= '<br>'.$a_content;
  }
  
  return $content;
}

/**
* Implements hook_node_presave
*/
function erpal_projects_helper_node_presave($node) {
  $type = $node->type;
 
  if ($type == 'erpal_timetracking') {
    erpal_projects_helper_node_presave_timetracking($node);
  }
}


/**
* Helper function to create new project link
*/
function _erpal_projects_helper_create_project_link($q_arg = false, $query_arr = array())
{
  if (!$q_arg)
    $q = current_path();
  else 
    $q = $q_arg;
  
  if (!isset($query_arr['destination']) || $q_arg)
    $query_arr['destination'] = $q;
  
  return l(
    t("Create new project"), "node/add/erpal-project", array(
        'query' => $query_arr,
    )
  );
}

/**
* returns the activity to a given node if the node is a erpal_task or erpal_project
*/
function _erpal_projects_helper_get_activity($node) {
  if ($node->type == 'erpal_task')
    return _erpal_projects_helper_get_activity_by_task($node);
  if ($node->type == 'erpal_project')
    return _erpal_projects_helper_get_activity_by_project($node);
  
}