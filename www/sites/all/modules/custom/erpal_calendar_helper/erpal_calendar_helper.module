<?php
/**
 * @file
 * Code for the erpal_calendar_helper module.
 */
module_load_include('inc', 'erpal_calendar_helper', 'inc/config');

/**
 * Implements hook_menu
 */ 
function erpal_calendar_helper_menu(){

	$items = array();
  
  require_once 'inc/config.inc';
  $config_items = _erpal_calendar_helper_config_menu();
  
  $items = array_merge($items, $config_items);
  return $items;
} 

/**
 * Implements hook_permission
 */
function erpal_calendar_helper_permission(){
  return array(
    'config erpal calendar' => array(
      'title' => t('Administer ERPAL calendar'), 
      'description' => t('Perform administration tasks for ERPAL calendar module.'),
    ),
    'access calendar view' => array(
      'title' => t('Access calendar view'), 
      'description' => t('Grant the user access to the calendar view.'),
    ),
  );
	
}

/**
* Implements date_item_presave provided by date item module, if a date item is about to be saved
*/
function erpal_calendar_helper_date_item_presave($date_item) {
  _erpal_calendar_helper_set_tag($date_item);
}

/**
* set a tag to the entity if one should be set
*/
function _erpal_calendar_helper_set_tag($date_item) {
  $current_tags = isset($date_item->field_date_item_tags[LANGUAGE_NONE]) ? $date_item->field_date_item_tags[LANGUAGE_NONE] : array();

  $src_type = $date_item->src_type;
  $src_entity = $date_item->src_entity();
  $src_bundle = _date_entity_entity_bundle($src_entity, $src_type);
  $src_field_name = $date_item->src_field_name;
  $term_to_set = _erpal_calendar_helper_field_tag($src_type, $src_bundle, $src_field_name);

  if (!$term_to_set)
    return;  //no term to set!
  
  $tag_is_set = false;
  foreach ($current_tags as $delta => $term_arr) {
    if ($term_arr['name'] == $term_to_set) {
      $tag_is_set = true;
    }    
  }

  if (!$tag_is_set) {
 
    //get field instance to get vocabulary of term refernce field
    $instance = field_info_field('field_date_item_tags');

    $vocab_machine_name = $instance['settings']['allowed_values'][0]['vocabulary'];
    //now get the vocabulary id from the vocabulary machine name
    $vocabs = taxonomy_get_vocabularies();
    $vid = false;
    foreach ($vocabs as $vocab) {
      if ($vocab->machine_name == $vocab_machine_name) {
        $vid = $vocab->vid;
        break;
      }
    }
    
    if (!$vid)
      return;  //bad! no vid found?!

    //get the tid of the term
    $term = taxonomy_get_term_by_name($term_to_set, $vocab_machine_name);
    if (!count($term)) {
      $term = false; 
    } else {
      $tid = array_keys($term);
      $tid = $tid[0];
      $term = $term[$tid];
    }

    //if term not exists, add it
    if (!$term && $term_to_set) {
      //@TODO
      $term = new stdClass();
      $term->name = $term_to_set;
      $term->vid = $vid;
      
      taxonomy_term_save($term);      
    }    

    $date_item->field_date_item_tags[LANGUAGE_NONE][0]['tid'] = $term->tid;
  }
  
}
