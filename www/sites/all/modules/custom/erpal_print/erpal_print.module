<?php
/**
 * @file
 * Module to provide helper functions and basic templates for creating pdf
 */

//marker is placed in html output to insert page breaks in pdf export
define('PDF_PAGE_BREAK', '###break###');
 
/**
* Implements hook_theme
*/ 
function erpal_print_theme() {
  return array(
    'doc_header' => array(
      'variables' => array(),
      'template' => 'template/doc_header',
    ),
    'doc_footer' => array(
      'variables' => array(),
      'template' => 'template/doc_footer',
    ),
    'erpal_print_toc' => array(
      'variables' => array('pdf_object' => NULL, 'title' => false),
      'template' => 'template/toc',
    ),
    'erpal_print_prepare_pdf' => array(
      'variables' => array('pdf_object' => NULL),
      'template' => 'template/prepare_pdf',
    ),
  );
}

/**
* Implements hook_form_alter to inject options into the basic settings form
*/
function erpal_print_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'erpal_basic_helper_config_form') {
    _erpal_print_inject_basic_config_form($form);
  }    
}

function _erpal_print_inject_basic_config_form(&$form) {
  //company logo
  $form['#attributes']['enctype'] = 'multipart/form-data';
  $form['#submit'][] = '_erpal_print_inject_basic_config_form_submit';
  
  $allowed_extensions = _erpal_print_logo_valid_extensions();

  $document_fid = variable_get('my_document_logo', false);
  $file = false;
  
  if ($document_fid) {
    $file = file_load($document_fid);
  } 
  
  $form['company_logo_document'] = array(
    '#type' => 'managed_file',
    '#weight' => -10,  //at the top of the page
    '#title' => t('Company logo for documents'),
    '#description' => t('Upload your logo that will be used in documents. Allowed file extensions: !extensions', array('!extensions' => implode(',', $allowed_extensions))),
    '#upload_validators' => array('file_validate_extensions' => array(implode(' ', $allowed_extensions))),
    '#upload_location' => _erpal_print_logo_documents_upload_dir(),
    '#default_value' => $file ? $file->fid : false,
  ); 
 
}

/**
* Submit handler for document logo file injection
*/
function _erpal_print_inject_basic_config_form_submit($form, $form_state)  {
  $values = $form_state['values'];
  $document_fid = $values['company_logo_document'];
  
  //finalise the file!
  $file = file_load($document_fid);
  $file->status = FILE_STATUS_PERMANENT;
  file_save($file);
  file_usage_add($file, 'erpal_print', 'config', $file->fid);
  
  variable_set('my_document_logo', $document_fid);  //save phone number
}
 
/**
* Function to render the given html string as PDF
* @param $html the html that should be rendered into pdf
* @param $destination_uri if set, PDF will be saved to the given destination folder (ONLY FOLDER!), otherwise
*   it will directly be given as download to the users
* @param $download_filename the filename if the document is put as download
* @param $params set author and title of the document
* @return a file object representing the temporaray file.
*/ 
function _erpal_print_html_as_pdf($html, $destination_uri=false, $basename=false, $params=false, $pdf_object=false, $print_toc=false) {
  global $user;
  
  if (!$pdf_object)    
    $pdf_object = erpal_print_prepare_tcpdf();
  
  $parts = _erpal_print_split_pages($html);
  foreach ($parts as $part_html) {
    $pdf_object->AddPage();
    $pdf_object->writeHTML($part_html, true, false, false, false, '');
  }
  
  if ($print_toc)
    _erpal_print_create_toc($pdf_object);
    
  //now output the pdf
  if ($destination_uri) {
    $destination_path = drupal_realpath($destination_uri."/".$basename);

    //perhaps file must be renamed
    $destination_path = file_destination($destination_path, FILE_EXISTS_RENAME);
    $new_basename = basename($destination_path);
    $destination_uri = $destination_uri.'/'.$new_basename;
    $pdf_object->Output($destination_path, "F");
    
    // Begin building file object.
    $file = new stdClass();
    $file->uid      = $user->uid;
    $file->status   = 1; //final!
    $file->filename = $basename;
    $file->uri      = $destination_uri;
    $file->filemime = file_get_mimetype($destination_path);
    $file->filesize = filesize($destination_path);
    
    file_save($file);

    return $file;
  } else {
    $pdf_object->Output($basename, "D");
    /**
    * prevent from further drupal output 
    */
    die();
  }
}

/**
* returns the author of the invoice
*/
function _erpal_print_get_author($node) {
  $a_user = user_load($node->uid);
  return $a_user->name;
}

/**
* Creates table of contents using a theme function
*/
function _erpal_print_create_toc($pdf_object) {    
  //create table of contents
  theme('erpal_print_toc', array('pdf_object' => $pdf_object, 'title' => t('Table of contents')));
}

/**
* Prepares and returns a TCPDF Object
*/
function erpal_print_prepare_tcpdf($params=false) {
  _erpal_print_require_tcpdf();

  require_once 'classes/ci_document.php';
  
  $pdf = new CI_document();
  
  theme('erpal_print_prepare_pdf', array('pdf_object' => $pdf));
  
  if (isset($params['author']) && $params['author'])
    $pdf->SetAuthor($params['author']);
  
  if (isset($params['title']) && $params['title'])
    $pdf->SetTitle($params['title']);
  
  return $pdf;
}

/**
* Require all files needed for tcpdf
*/
function _erpal_print_require_tcpdf() {
  //now make a pdf out of that HTML body!
  //include the tcpdf with the library module
  $tcpdf_path = libraries_get_path('tcpdf');

  //now require TCPDF to render the invoice output as PDF
  require_once $tcpdf_path."/tcpdf.php";
  require_once($tcpdf_path.'/config/lang/ger.php');
}

/**
* Function to split HTML at marker position to get a new page in PDF
*/
function _erpal_print_split_pages($html){
  $parts = explode(PDF_PAGE_BREAK, $html);
  
  return $parts;
}

/**
* Function returns the path to the logo for the invoice
*/
function erpal_print_logo_path($relative = false) {
  $doc_root = $_SERVER['DOCUMENT_ROOT'];  

  $logo_fid = variable_get('my_document_logo', false);
  
  if (!$logo_fid)
    return ''; 

  $file = file_load($logo_fid);
  if (!isset($file->uri))
    return '';
   
  if ($relative) {
    //@TODO we need a relative path. Is there no other way to get it e.g. with a uri function or a stream wrapper?
    $full_url = file_create_url($file->uri);
    $base_url = $GLOBALS['base_url'];
    
    //now cut the prefix to get the path
    $rel_path = substr($full_url, strlen($base_url), strlen($full_url));
    return $rel_path;
  }
   
  return file_create_url($file->uri);
}

/**
* Returns the path relative to the files directory where the documents logo will be uploaded
*/
function _erpal_print_logo_documents_upload_dir() {
  
  $uri = "public://erpal_res";
  
  //prepare the folder
  file_prepare_directory($uri,  FILE_CREATE_DIRECTORY);
  return $uri;
}

/**
* returns the valid file extensions to upload a logo
*/
function _erpal_print_logo_valid_extensions() {
  return array('png', 'jpg', 'jpeg');
}